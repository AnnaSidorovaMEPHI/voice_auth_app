import os
from os.path import join as p_join
import sys
import glob
import shutil
import numpy as np

# for speech recognition and comparison
from sklearn.feature_extraction.text import CountVectorizer
from speech_recognizer import Recognizer
from utils import normalize_text, compare_vectors

# for auth
from sklearn.neighbors import LocalOutlierFactor
from sklearn.metrics import accuracy_score, confusion_matrix
from features import get_features

# other
from utils import get_wav_signal, load_json


class Authenticator(object):
    def __init__(self):
        self.legitimate_dir = None
        self.n_neigh = 7
        self.LOF = LocalOutlierFactor(n_neighbors=self.n_neigh, novelty=True)
        # speech recognition
        self.recognizer = Recognizer()
        self.reco_treshold = 0.7
        # test
        self.vect = CountVectorizer(max_features=5000, binary=True)

    def _train(self):
        features = np.array([[]] * 13)
        wavs = glob.glob(p_join(self.legitimate_dir, '*.wav'))
        if not wavs:
            sys.stdout.write("There are no wavs in " +
                             self.legitimate_dir)
            sys.exit(1)
        for i, w in enumerate(wavs):
            try:
                fs, signal = get_wav_signal(w)
                ftr = get_features(fs, signal)
                if i == 0:
                    features = ftr
                else:
                    features = np.append(features, ftr, axis=1)
            except Exception as e:
                sys.stdout.write(w + " error " + str(e))
        features = features.transpose()
        self.LOF.fit(features)
        shutil.rmtree(self.legitimate_dir + "aftervad")

    def authenticate(self, input_dir1, wav_record, true_text):
        if wav_record:
            self.legitimate_dir = input_dir1
            self._train()
            # LOF prediction
            fs, signal = get_wav_signal(wav_record)
            ftr = get_features(fs, signal)
            test_features = ftr
            test_features = test_features.transpose()
            predict = self.LOF.predict(test_features)
            # Speech recognition
            index = os.path.basename(wav_record).split('.')[0]
            true_text_norm = normalize_text(true_text)
            pron = self.recognizer.recognize(wav_record)
            pron_text = normalize_text(pron)
            if pron_text:
                # Check phrase (vectorizing for comparison)
                self.vect.fit([true_text_norm])
                true_vect = self.vect.transform([true_text_norm]).toarray()[0]
                # print('\nФраза-образец, её нормальная форма и векторное представление:\n', true_text+"\n", true_text_norm+"\n", '--->', true_vect)
                new_vect = self.vect.transform([pron_text]).toarray()[0]
                # print('Произнесённая фраза, её нормальная форма и векторное представление:\n', pron+"\n", pron_text+"\n", '--->', new_vect)
                reco_accuracy = compare_vectors(true_vect, new_vect)
            else:  # If record is empty
                reco_accuracy = 0.0
            return reco_accuracy >= self.reco_treshold and predict[0] == 1
        else:
            sys.stdout.write("Error in " + wav_record + "\n")
            return None
                                                                                                                                                           
    def test(self, test_dir, true_labels):                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        test_wavs = sorted(glob.glob(p_join(test_dir, '*.wav')))
        test_features = []
        if not test_wavs:
            sys.stdout.write("Error in " + test_dir + "\n")
            sys.exit(1)
        for i, w in enumerate(test_wavs):
            try:
                # Speech recognition                        
                index = os.path.basename(w).split('.')[0]
                true_text = normalize_text(self.transcr[index])
                pron_text = normalize_text(self.recognizer.recognize(w))                                                                       
                if pron_text:                                                                                                                                                                                                                                                                                                                                              
                    # Vectorizing for comparison
                    self.vect.fit([true_text])
                    true_vect = self.vect.transform([true_text]).toarray()[0]
                    new_vect = self.vect.transform([pron_text]).toarray()[0]
                    reco_accuracy = compare_vectors(true_vect, new_vect)
                else:  # If record is empty
                    reco_accuracy = 0.0
                sys.stdout.write("Accuracy of speech recognition on the "
                                 + os.path.basename(w) + " record is:"
                                 + str(reco_accuracy) + "\n")
                # Test of voice auth (evaluating the correctness of a keyword)
                fs, signal = get_wav_signal(w)
                ftr = get_features(fs, signal)
                if i == 0:
                    test_features = ftr
                else:
                    test_features = np.append(test_features, ftr, axis=1)
            except Exception as e:
                sys.stdout.write(w + " error " + str(e) + "\n")
            shutil.rmtree(test_dir + "aftervad")
        test_features = test_features.transpose()
        # Local Outlier Factor:
        predict = self.LOF.predict(test_features)
        for i, one in enumerate(predict):
            if one == -1:
                predict[i] = 0
        # Metrics
        n = confusion_matrix(true_labels, predict)
        acc = accuracy_score(true_labels, predict)
        tn, fp, fn, tp = n.ravel()
        fpr = fp/(fp + tn)
        fnr = fn/(tp + fn)
        return acc, fpr, fnr